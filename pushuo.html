<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Push-Up Tracker ðŸ’ª</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
<style>
  body{
    margin:0;
    background:radial-gradient(circle at center,#111 0%,#000 100%);
    color:#0ff;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    font-family:'Poppins',sans-serif;
    height:100vh;overflow:hidden;
  }
  #count{font-size:3em;margin:8px 0;font-weight:600;text-shadow:0 0 10px #0ff;}
  #container{
    position:relative;width:90%;max-width:420px;aspect-ratio:3/4;
    border:2px solid #0ff;border-radius:16px;overflow:hidden;
    box-shadow:0 0 20px #0ff4;
  }
  video,canvas{
    position:absolute;top:0;left:0;width:100%;height:100%;
    transform:scaleX(-1);object-fit:cover;
  }
  #note{margin-top:12px;font-size:1em;color:#aaa;text-align:center;}
</style>
</head>
<body>
<div id="count">0</div>
<div id="container">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
</div>
<div id="note">Face the camera ðŸ“· â€” get into push-up position to start!</div>

<script>
let detector,video,canvas,ctx;
let count=0,state="up",ready=false,readyFrames=0;
let yHist=[];
const DOWN_THR=20,UP_THR=50,SMOOTH=5;

function angle(a,b,c){
  const ab=[a.x-b.x,a.y-b.y], cb=[c.x-b.x,c.y-b.y];
  const dot=ab[0]*cb[0]+ab[1]*cb[1];
  return Math.acos(dot/(Math.hypot(...ab)*Math.hypot(...cb)))*180/Math.PI;
}

async function init(){
  video=document.getElementById("video");
  canvas=document.getElementById("canvas");
  ctx=canvas.getContext("2d");
  const s=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=s;
  detector=await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet);
  requestAnimationFrame(loop);
}

async function loop(){
  if(!video.videoWidth){requestAnimationFrame(loop);return;}
  canvas.width=video.videoWidth;canvas.height=video.videoHeight;
  const poses=await detector.estimatePoses(video);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(poses.length){
    const k=poses[0].keypoints;
    const map={}; k.forEach(p=>map[p.name]=p);
    const {nose,left_shoulder,right_shoulder,left_elbow,right_elbow,
           left_wrist,right_wrist,left_hip,right_hip}=map;

    drawSkeleton(k);

    // --- improved posture check ---
    if(!ready){
      if(left_shoulder&&right_shoulder&&left_hip&&right_hip&&left_wrist&&right_wrist&&nose){
        const shouldersLevel=Math.abs(left_shoulder.y-right_shoulder.y);
        const hipsLevel=Math.abs(left_hip.y-right_hip.y);
        const wristsLevel=Math.abs(left_wrist.y-right_wrist.y);
        const wristsBelowShoulders=(left_wrist.y>left_shoulder.y+60)&&(right_wrist.y>right_shoulder.y+60);
        const noseBelowShoulders=(nose.y>Math.min(left_shoulder.y,right_shoulder.y)+50);
        const bodyFlat=shouldersLevel<40 && hipsLevel<40;

        if(bodyFlat && wristsLevel<60 && wristsBelowShoulders && noseBelowShoulders){
          readyFrames++;
          if(readyFrames>20){
            ready=true;
            document.getElementById("note").textContent="âœ… Push-up position detected! Start!";
          }
        } else {
          readyFrames=0;
        }
      }
      requestAnimationFrame(loop);
      return;
    }

    // --- once ready, normal counting ---
    let elbowsBent=false;
    if(left_shoulder&&left_elbow&&left_wrist&&right_shoulder&&right_elbow&&right_wrist){
      const leftAng=angle(left_shoulder,left_elbow,left_wrist);
      const rightAng=angle(right_shoulder,right_elbow,right_wrist);
      if(leftAng<110 && rightAng<110) elbowsBent=true;
    }

    if(nose && nose.score>0.4){
      yHist.push(nose.y); if(yHist.length>SMOOTH) yHist.shift();
      const avgY=yHist.reduce((a,b)=>a+b)/yHist.length;
      if(state==="up" && avgY>canvas.height/2+DOWN_THR && elbowsBent) state="down";
      else if(state==="down" && avgY<canvas.height/2-UP_THR && !elbowsBent){
        state="up"; count++; update();
      }
    }
  }
  requestAnimationFrame(loop);
}

function drawSkeleton(kp){
  const pairs=[["left_shoulder","left_elbow"],["left_elbow","left_wrist"],
               ["right_shoulder","right_elbow"],["right_elbow","right_wrist"],
               ["left_shoulder","right_shoulder"],["left_hip","right_hip"],
               ["left_shoulder","left_hip"],["right_shoulder","right_hip"]];
  ctx.lineWidth=2; ctx.strokeStyle="#0f0"; ctx.fillStyle="#0f0";
  const map={}; kp.forEach(p=>map[p.name]=p);
  pairs.forEach(([a,b])=>{
    const pa=map[a],pb=map[b];
    if(pa&&pb&&pa.score>0.4&&pb.score>0.4){
      ctx.beginPath();ctx.moveTo(pa.x,pa.y);ctx.lineTo(pb.x,pb.y);ctx.stroke();
    }
  });
  ["left_wrist","right_wrist","nose"].forEach(n=>{
    const p=map[n]; if(p&&p.score>0.4){
      ctx.beginPath();ctx.arc(p.x,p.y,5,0,2*Math.PI);
      ctx.fillStyle=n==="nose"?"#0ff":"#f0f";
      ctx.fill();
    }
  });
}

function update(){
  document.getElementById("count").textContent=count;
  if(window.ReactNativeWebView)
    window.ReactNativeWebView.postMessage(JSON.stringify({type:"count",count}));
}

init().catch(e=>alert("Camera error: "+e));
</script>
</body>
</html>
