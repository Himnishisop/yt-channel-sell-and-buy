<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Push-up Counter (Stickman)</title>

<!-- Google CDN scripts -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js"></script>

<style>
  body {
    margin: 0;
    background: #000;
    color: #0ff;
    font-family: sans-serif;
    text-align: center;
  }
  #count {font-size: 3em; margin-top: 10px; text-shadow: 0 0 10px #0ff;}
  #status {color: #aaa; margin: 5px;}
  #card {position: relative; display: inline-block; border: 2px solid #0ff; border-radius: 12px; overflow: hidden;}
  video, canvas {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover; transform: scaleX(-1);
  }
</style>
</head>
<body>
<h1>Push-up Counter ðŸ’ª</h1>
<p id="count">0</p>
<p id="status">Allow camera and stand in frame</p>
<div id="card" style="width: 400px; aspect-ratio: 3/4;">
  <video id="video" playsinline></video>
  <canvas id="canvas"></canvas>
</div>

<script>
const DOWN_DELTA=0.06, ELBOW_BEND=110, WRIST_HIP_Z=-0.25, BODY_LEVEL_Y=0.12;
let count=0, phase="up", ready=false, readyFrames=0, noseHist=[], SMOOTH=6;

const v=document.getElementById("video");
const c=document.getElementById("canvas");
const ctx=c.getContext("2d");
const countEl=document.getElementById("count");
const statusEl=document.getElementById("status");

function deg(a,b,c){
  const ab=[a.x-b.x,a.y-b.y,a.z-b.z], cb=[c.x-b.x,c.y-b.y,c.z-b.z];
  const dot=ab[0]*cb[0]+ab[1]*cb[1]+ab[2]*cb[2];
  return Math.acos(dot/(Math.hypot(...ab)*Math.hypot(...cb)))*180/Math.PI;
}
function avg(a){return a.reduce((x,y)=>x+y)/a.length;}

function onResults(res){
  if(!res.poseLandmarks)return;
  const lm=res.poseLandmarks;
  const n=lm[0], lS=lm[11], rS=lm[12], lE=lm[13], rE=lm[14],
        lW=lm[15], rW=lm[16], lH=lm[23], rH=lm[24], lA=lm[27], rA=lm[28];

  c.width=v.videoWidth; c.height=v.videoHeight;
  ctx.save(); ctx.clearRect(0,0,c.width,c.height);
  drawConnectors(ctx, lm, POSE_CONNECTIONS, {color:'#0f0', lineWidth:3});
  drawLandmarks(ctx, lm, {color:'#ff0', radius:3});
  ctx.restore();

  const avgHipZ=(lH.z+rH.z)/2, avgWristZ=(lW.z+rW.z)/2;
  const wristCloser=avgWristZ<avgHipZ+WRIST_HIP_Z;
  const wristsBelowShoulders=(lW.y>lS.y+0.15)&&(rW.y>rS.y+0.15);
  const shouldersFlat=Math.abs(lS.y-rS.y)<BODY_LEVEL_Y;
  const hipsFlat=Math.abs(lH.y-rH.y)<BODY_LEVEL_Y;
  const bodyFlat=shouldersFlat&&hipsFlat;

  if(!ready){
    if(wristCloser&&wristsBelowShoulders&&bodyFlat){
      readyFrames++; statusEl.textContent=`Detecting posture... ${readyFrames}/15`;
      if(readyFrames>15){ready=true; statusEl.textContent="âœ… Push-up posture detected";}
    }else{readyFrames=0;}
    return;
  }

  const leftAng=deg(lS,lE,lW), rightAng=deg(rS,rE,rW);
  const bent=(leftAng<ELBOW_BEND&&rightAng<ELBOW_BEND);
  noseHist.push(n.y); if(noseHist.length>SMOOTH) noseHist.shift();
  const avgNose=avg(noseHist);
  const torsoY=(lS.y+rS.y+lH.y+rH.y)/4;

  if(phase==="up"&&avgNose>torsoY+DOWN_DELTA&&bent)phase="down";
  else if(phase==="down"&&avgNose<torsoY-DOWN_DELTA&&!bent){
    phase="up"; count++; countEl.textContent=count; statusEl.textContent=`Reps: ${count}`;
  }
}

const pose=new Pose({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`});
pose.setOptions({modelComplexity:1,smoothLandmarks:true,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
pose.onResults(onResults);

const cam=new Camera(v,{onFrame:async()=>{await pose.send({image:v});},width:480,height:640});
cam.start().catch(e=>statusEl.textContent="Camera blocked: allow it!");
</script>
</body>
</html>
