<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Push-Up Tracker ðŸ’ª</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
<style>
  body{
    margin:0;
    background:radial-gradient(circle at center,#111 0%,#000 100%);
    color:#0ff;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    font-family:'Poppins',sans-serif;
    height:100vh;overflow:hidden;
  }
  #container{
    position:relative;width:90%;max-width:420px;aspect-ratio:3/4;
    border:2px solid #0ff;border-radius:16px;overflow:hidden;
    box-shadow:0 0 20px #0ff4;
  }
  video,canvas{
    position:absolute;top:0;left:0;width:100%;height:100%;
    transform:scaleX(-1);
    object-fit:cover;
  }
  #overlay{
    position:absolute;bottom:0;width:100%;background:rgba(0,0,0,0.5);
    text-align:center;padding:8px 0;color:#0ff;font-size:0.9em;
  }
  #count{
    font-size:3em;margin:8px 0;font-weight:600;text-shadow:0 0 10px #0ff;
  }
  #note{
    margin-top:12px;font-size:1em;color:#aaa;text-align:center;
  }
</style>
</head>
<body>
<div id="count">0</div>
<div id="container">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="overlay">Keep your face toward the camera ðŸ“·</div>
</div>
<div id="note">Face-based push-up counter â€” move close &amp; far from camera.</div>

<script>
let detector,video,canvas,ctx;
let count=0,state="up",yHist=[];
const DOWN_THR=20,UP_THR=50,SMOOTH=5;

async function init(){
  video=document.getElementById("video");
  canvas=document.getElementById("canvas");
  ctx=canvas.getContext("2d");
  const stream=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=stream;
  detector=await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet);
  requestAnimationFrame(loop);
}

async function loop(){
  if(!video.videoWidth){requestAnimationFrame(loop);return;}
  canvas.width=video.videoWidth;canvas.height=video.videoHeight;
  const poses=await detector.estimatePoses(video);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(poses.length){
    const k=poses[0].keypoints;
    const nose=k.find(p=>p.name==="nose");
    if(nose && nose.score>0.4){
      ctx.fillStyle="#0f0";
      ctx.beginPath();ctx.arc(nose.x,nose.y,5,0,2*Math.PI);ctx.fill();

      yHist.push(nose.y); if(yHist.length>SMOOTH) yHist.shift();
      const avgY=yHist.reduce((a,b)=>a+b)/yHist.length;

      if(state==="up" && avgY>canvas.height/2+DOWN_THR){state="down";}
      else if(state==="down" && avgY<canvas.height/2-UP_THR){
        state="up";count++;update();
      }
    }
  }
  requestAnimationFrame(loop);
}

function update(){
  document.getElementById("count").textContent=count;
  if(window.ReactNativeWebView){
    window.ReactNativeWebView.postMessage(JSON.stringify({type:"count",count}));
  }
}

init().catch(e=>alert("Camera error: "+e));
</script>
</body>
</html>
